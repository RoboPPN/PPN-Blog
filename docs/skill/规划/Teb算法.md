## 局部路径规划需要的输入与输出

 ![导航包move_base框架图](https://img-blog.csdnimg.cn/22866c65da7249ea896c1b0e40779476.png)

 上图中的local_planner接收global_planner生成的全局路径以及里程计信息还有local_costmap的局部代价地图信息，最后输出的是速度控制信息。

## Teb简介

 Timed-Elastic-Band（简称Teb），属于局部路径规划的一种。

 Elastic-Band方法，就是连接起点与目标点，并让这个路径可以变形，变形的条件就是将所有约束力当做橡皮筋的外力。

 定义Elastic-Band：

- 起点与目标点由全局规划器指定，在这条全局路径中插入N个控制橡皮筋形状的控制点（机器人姿态）；

- 为了显示轨迹的运动学信息，我们在点与点之间定义运动时间Time；

- time+elastic band = timed elastic band；

- 于是，这个方法就叫做Timed-Elastic-Band；

![请添加图片描述](https://img-blog.csdnimg.cn/b13ac176267a401e9219aa48c09fbde9.png)

上图中的黑色虚线是全局路径，按照相同的时间间隔来插入每个点。

这个路径可以变形，变形的条件就是将所有约束当做橡皮筋的外力。例如：机器人与障碍物的最小距离就是一个约束

因为小车的速度和加速度都是有最大值的，所以两个点之间不能有太大的姿态跳变。

:::caution
每个目标函数（约束条件）只与elastic band 中的某几个连续状态有关，而非整条band。

换一种说法就是：每一种约束其实它影响的只是某几个连续的状态。
:::

### Teb常见的四种约束

1. 跟随全局规划路径+避障；
2. 速度、加速度约束；
3. 运动学约束
   不希望机器人发生飘逸，轨迹需由若干弧段组成的平滑轨迹；
4. 最快路径约束
   最快路径并非空间上的最短路径；

## Teb优化

当将所有约束变成目标函数，需要对目标函数求解。

![请添加图片描述](https://img-blog.csdnimg.cn/ef7f3a6b6ceb44bc9da5f02594c4763f.png)
上图就是对多个目标函数进行优化，是一个BA（bundle adjustment约束调整）问题。

简而言之，虽然待优化的橡皮筋有不少状态点与时间段，目标函数也好像很多。但是，每个目标函数只与橡皮筋中的某几个状态有关，而非整条橡皮筋。认识到这是一个稀疏优化（Sparse Optimization）问题就比较容易了。

![请添加图片描述](https://img-blog.csdnimg.cn/393cbef9482d4e999f7312111dedf64e.gif)

如图，这个图的节点vertexs是橡皮筋的状态（机器人姿态+时间）；图的边edges是我们自己定义的优化目标函数。

求解的框架，自然是可以去使用g2o（A General Framework for Graph Optimization）了。当然，节点和边的类型需要我们自己利用g2o中的模板定义。

## Teb工作流程

全局路径----加入约束----g2o优化----输出速度

## Teb与DWA对比

teb在运动过程中会调整自己的位姿朝向，当到达目标点时，通常机器人的朝向也是目标朝向而不需要旋转。dwa则是先到达目标坐标点，然后原地旋转到目标朝向。对于两轮差速底盘，teb在运动中调节朝向会使运动路径不流畅，在启动和将到达目标点时出现不必要的后退。这在某些应用场景里是不允许的。因为后退可能会碰到障碍物。而原地旋转到合适的朝向再径直走开是更为合适的运动策略。这也是teb需要根据场景要优化的地方。

## 局部规划改进

### 起始点旋转

TEB局部规划时，当起始点的机器人朝向没有朝向目标点，规划出的路线会考虑倒车旋转来把朝向修正过来。但在一些场景这样的倒退和修正角度的挪动是不允许的。所以针对两轮差速的运动模型，可以先让底盘原地旋转，使其朝向目标点。然后再执行优化函数，得到最优轨迹。这样能省去一些不必要的朝向调整的轨迹操作。

### 终点的旋转

先将终点的机器人朝向缓存下来。然后可以使用起始点向终点的朝向覆盖掉终点的朝向。开启优化操作。当机器人已经到达目标点时，再对比此时朝向与缓存的目标朝向。当朝向有差异时，原地旋转到目标朝向即可。这样也是为了省去一些不必要的朝向调整的轨迹操作。

### 根据前方障碍物距离调整最大线速度

在updateObstacleContainerWithCostmap()函数中，会根据costmap中的障碍物信息更新障碍物容器。在这里，可以找到前方距离障碍物的最短距离。然后根据该距离值调整max_vel_x。这样优化时最大线速度的约束会随着障碍物的远近而调整。在一定程度上会改善避障效果。

### 防止过冲

有时机器人会冲过全局目标点，然后又回转。这样的现象肯定是影响效果的。所以可以根据机器人当前位置距离全局目标点的距离来调整max_vel_x。距离全局目标点远时可以把max_vel_x放大一点，距离全局目标点近时可以把max_vel_x放小一点。我们可以设计一个公式来做这件事。输入为与全局目标点的距离，输出为max_vel_x。这样可以防止过冲现象。

### 增加边约束

根据场景自定义橡皮筋约束，可根据使用场景实现自己的优化效果。
